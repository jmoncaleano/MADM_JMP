---
title: "Final_Black_Friday"
author: "Julian Andres Moncaleano - Fernando Rodriguez Romero"
date: "`r Sys.Date()`"
output: #pdf_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=8, fig.height=8, fig.align="center", echo=TRUE, warning=FALSE, message=FALSE)

rm(list=ls())
cat("\014")

library(tidyverse)
library(tidyr)
library(ggplot2)
library(tabplot)
library(dummies)
library(FNN)
library(caret)
library(scales)
library(rpart)
library(rpart.plot)
library(tree)
library(randomForest)
library(gbm)
```


```{r Datos, include=FALSE}

setwd("C:/Users/rasal/Documents/GitHub/Black Friday")
data <- read.csv("BlackFriday.csv", header = TRUE, na.strings = "")
friday <- as_tibble(data)
attach(friday)
old.par = par()
```

## **Black Friday DataSet**

Para el desarrollo de este trabajo se tomá del sitio Web Kaggle (https://www.kaggle.com/mehdidag/black-friday) el conjunto de datos *Black Friday*, datos de 550mil observaciones en 12 variables sobre el viernes negro en una tienda minorista.

```{r Evaluacion_datos, include=FALSE}

Factores <- matrix( c(length(unique(friday$User_ID)), length(unique(friday$Occupation)), 
                      length(unique(friday$Marital_Status)),  
                      length(unique(friday$Product_Category_1)),
                      length(unique(friday$Product_Category_2)), 
                      length(unique(friday$Product_Category_3)), 
                      length(unique(friday$Purchase))),
                    nrow = 1, ncol = 7)
dimnames(Factores) <- list("Factores", c("User_ID", "Occupation", "Marital_Status", 
                                         "Product_Category_1", "Product_Category_2", 
                                         "Product_Category_3", "Purchase"))

# Todos al menos compraron un tipo de producto
nrow(filter(friday, is.na(friday$Product_Category_2) & is.na(friday$Product_Category_3)            & is.na(friday$Product_Category_1)))

# Conversion a factor de las variables posibles
User_ID <- User_ID %>% as.factor()
Occupation <- Occupation %>% as.factor()
Marital_Status <- Marital_Status %>% as.factor()


#Missing data - 
friday.na <- c()
for(j in 1:length(friday)){
  friday.na[j] <- sum(is.na(friday[,j]))
}

#Solo se tienen datos no disponibles en los productos category 2 y 3, es normal
na_names <- names(friday[,which(friday.na!=0)])

fil <- filter(friday, !is.na(Product_Category_2) & is.na(Product_Category_1))
cmp_2_no1 <- nrow(fil)
fil1 <- filter(friday, is.na(Product_Category_2) & !is.na(Product_Category_3))
cmp_3_no2 <- nrow(fil1)

```

## **Evaluación Tipos de Datos**

Inicialmente evaluamos las variables tipo factor y los datos unicos que toman:

```{r Tablas1, echo=FALSE}
knitr::kable(Factores, caption = "Factores")

```

Para la ejecución del trabajo tomamos la determinación de convertir las variables *User_ID*, *Occupation* y *Marital_Status* a tipo Factor.

## **Limpieza de Información No Disponible**

A continuación realizamos la evaluación de información tipo no disponible (NAN) y estos datos únicamente se presentan en las variables `r na_names[1]` y `r na_names[2]`. Sin embargo, esta información es consecuente con el contexto del conjunto de datos, ya que al confirmar que todos los usuarios comparon al menos un tipo de categoria, los datos no disponibles cruzados entre compras cruzadas para las categorias 2 y 3 se tienen un total de `r cmp_2_no1` y entre las categorias 3 y 2 de `r cmp_3_no2`, indicando compras de una categoria pero no todas, eliminarlos sesga la información al dejar solo datos de productos comprados en todas las categorias, por está razón solo realizamos tratamiento sobre datos no disponibles para categorización por Random Forest, creando variables dummy de la existencia de datos en las categorias 2 y 3. 

## **Outliers**

Inicialmente este análisis será dirigido al gasto realizado por usuarios agrupado por productos, de está manera realizamos la evaluación de información aislada (Outliers), a través de diagramas tipo boxplot respecto a la variable *Purchase*:

```{r Plot_Outliers1, echo=FALSE}

par(old.par)
par(mfrow = c(3, 3))

boxplot(Purchase ~ Product_Category_1,
        data = friday,
        main = "Pruchase - Cat1")

boxplot(Purchase ~ Product_Category_2,
        data = friday,
        main = "Pruchase - Cat2")

boxplot(Purchase ~ Product_Category_3,
        data = friday,
        main = "Pruchase - Cat3")

boxplot(Purchase ~ Age,
        data = friday,
        main = "Pruchase - Age")

#Se distribuyen uniformemente
boxplot(Purchase ~ Gender,
        data = friday,
        main = "Pruchase - Genero")

#Se distribuyen uniformemente
boxplot(Purchase ~ Occupation,
        data = friday,
        main = "Pruchase - Ocupacion")

#Se distribuyen uniformemente
boxplot(Purchase ~ Marital_Status,
        data = friday,
        main = "Pruchase - Marital")

#Se distribuyen uniformemente en tipo A y B
boxplot(Purchase ~ City_Category,
        data = friday,
        main = "Pruchase - Ciudad")

#Se distribuyen uniformemente
boxplot(Purchase ~ Stay_In_Current_City_Years,
        data = friday,
        main = "Pruchase - Estancia")

```

Se puede observar que el gasto se encuentra uniformemente distribuido dentro de las variables *Age*, *Género*, *Ocupación*, *Estado Marital*, *Categoria Ciudad* y *Tiempo en la Ciudad*, con una media entre 6000 y 7000. Respecto a las categorías de productos debido a que condicionan los precios es de esperarse el comportamiento de los gráficos. De igual manera se puede concluir que los *Outliers* también se distribuyen uniformente dentro de las variables mencionada. 

```{r Plot_Outliers2, echo=FALSE}
#Total Purchase
par(old.par)
par(mfrow = c(1,2))
boxplot(friday$Purchase, 
        main = "Purchase",
        boxmex = 0.1)

hist(Purchase, freq = TRUE)
```

Por esta razón se realiza un proceso de remplazo de Outliers de acuerdo a los rangos intercuantiles sobre un 5% por debajo y un 95% por encima: 


```{r Outliers, include=FALSE}
replace_outliers <- function(x, removeNA=FALSE){
  qrts <- quantile(x, probs = c(0.25, 0.75), na.rm = removeNA)
  caps <- quantile(x, probs = c(0.05, 0.95), na.rm = removeNA)
  h <- 1.5 * IQR(x)
  x[x<qrts[1]-h] <- caps[1]
  x[x>qrts[2]+h] <- caps[2]
  x 
}

friday$purchase_replace <- replace_outliers(Purchase)

```

Una vez realizado el procedimiento, no tenemos valores *Outlier*.

```{r Plot_Outliers3, echo=FALSE}
par(old.par)
par(mfrow = c(1,2))
boxplot(friday$purchase_replace, 
        main = "Purchase",
        boxmex = 0.1)

hist(friday$purchase_replace, freq = TRUE)

```

## **Categorización de los Datos**

Con el fin de determinar un éstandar en las compras, realizamos una categorización de la variable *Purchase*, dando los valores de "Very_low", "Low", "Medium", "High" y "Very_high", tomando los cortes de acuerdo al último histograma con cortes entre 0 a 2500, 2501 a 4500, 4501 a 14000, 14001 a 18000 y 18001 al máximo, respectivamente y lo incluimos en una nueva variable.

```{r Categorizacion_datos, include=FALSE}
#Categorizamos los valores de compras
break_f <- c(-Inf, 2500, 4500, 14000, 18000, Inf)
friday$Purchase_cat <- cut(friday$purchase_replace, breaks = break_f, labels = c("Very_low", "Low", 
                                                                             "Medium", "High", 
                                                                             "Very_high"))

```

Una vez categorizada esta nueva variable, evaluamos la distribución de todas las variables categoricas donde es posible observar:

1. En género tenemos mayor cantidad de compras por parte de hombres.
2. La edad más recurrente es entre 26 y 35.
3. La ciudad tipo B presenta mayor cantidad de compras, pero sin una diferencia importante.
4. Se presentan mayores compras entre 2501 y 4500, catalogado como "Medium".

```{r Plot_Categorizacion_datos1, echo=FALSE}

#Distribución información tipo factor
friday_to_plot <- tablePrepare(friday)
tableplot(friday_to_plot, select = c(Product_ID, Gender, Age, City_Category, 
                                     Stay_In_Current_City_Years, Purchase_cat),
          sortCol = Purchase_cat)

```


Realizando un diagrama de homogeneidad sobre el gasto respecto a la edad y género, podemos concluir que la media de gasto es uniforme, sin embargo a pesar de haber tratado los Outliers, en el género femenino se observan nuevamente estos comportamientos de compras muy alejadas a la media. Adicionalmente se nota que los hombres gastan mas que las mujeres en todas las edades.

```{r Plot_Categorizacion_datos2, echo=FALSE}

#Homogeneidad de la varianza en las compras respecto a sexo y edad

bwplot(friday$purchase_replace ~ friday$Age | friday$Gender, data = friday,
                             strip = strip.custom(bg = 'grey'),
                             cex = 1.0, layout = c(2, 1),
                             xlab = "Edades x Género", 
                             ylab = "Tasa de Compras",
                             par.settings = list(
                               box.rectangle = list(col = 5),
                               box.umbrella  = list(col = 2),
                               plot.symbol   = list(cex = 1.5, col = 1)),
                             scales = list(x = list(relation = "same"),
                                           y = list(relation = "same")))

####Incluir grafico de homogeneidad por usuario
```


## **Exploración de los Datos**

A continuación realizamos una evaluación de gastos respecto a sus categorias, para esto colapsamos las variables Product_Category 1, 2 y 3, de tal manera que nos permita agrupar el tipo por categoria y evalúar si distribución.

```{r Exploracion_Datos, include=FALSE}
friday_product <- gather(friday, na.rm = TRUE,
                         key = "ProductCat",
                         value = "ProductType",
                         Product_Category_1, Product_Category_2, Product_Category_3)



category1 <- subset(friday_product, friday_product$ProductCat == "Product_Category_1")$purchase_replace
category2 <- subset(friday_product, friday_product$ProductCat == "Product_Category_2")$purchase_replace
category3 <- subset(friday_product, friday_product$ProductCat == "Product_Category_3")$purchase_replace
```

Con un diagrama de densidad podemos observar las diferencias entre la media y mediana por categoria y la distribución de gastos por cada categoria. Estas medidas presentan diferencias importantes para las categorias 1 y 2, mientras que en la categoria 3 son muy cercanas, concluyendo que las categorias 1 y 2 son muy receptivas a compras de valores grandes, indicando que estas categorias tienen una mayor ganancia por la cantidad comprada, mientras que la categoria 3 respecto a su precio.

```{r Plot_Exploracion_Datos1, echo=FALSE}

par(old.par)

par(mfrow = c(3,1))

hist(category1, prob = TRUE, xlab = "Categoria1", main = "Compras Categoria 1")
lines(density(category1))
abline(v = mean(category1), col = "red")
abline(v = median(category1), col = "blue")

hist(category2, prob = TRUE, xlab = "Categoria2", main = "Compras Categoria 2")
lines(density(category2))
abline(v = mean(category2), col = "red")
abline(v = median(category2), col = "blue")

hist(category3, prob = TRUE, xlab = "Categoria3", main = "Compras Categoria 3")
lines(density(category3))
abline(v = mean(category3), col = "red")
abline(v = median(category3), col = "blue")


```


A continuación realizamos una evaluación de gastos respecto a la condición relacionada al usuario, como son las variables de género, ocupación y estado marital.

Podemos observar una media constante en el gasto para todos las variables, sin embargo nuevamente concluimos que los hombres compran más; las ocupaciones tipo 7, 8, 12, 15 y 17 compran más y las ocupaciones 1, 9 y 13 tiene  gastos particulares en exceso que es valido evaluar de manera independiente; finalmente el estado marital tiene un comportamiento similar para ambos factores, con algunos gastos inusuales para el estado casado.

```{r Plot_Exploracion_Datos2, echo=FALSE}

par(old.par)

a1 <- friday %>% ggplot(aes(x=Gender,y=purchase_replace,fill=Gender))+geom_boxplot()+
  theme(legend.position="none")
a2 <- friday %>% ggplot(aes(x=Occupation,y=purchase_replace,
                            fill=as.factor(Occupation)))+geom_boxplot()+
  theme(legend.position="none")
a3 <- friday %>% ggplot(aes(x=as.factor(Marital_Status),y=purchase_replace,
                            fill=as.factor(Marital_Status)))+geom_boxplot()+
  theme(legend.position="none")

gridExtra::grid.arrange(a1,a2,a3)


```

Evaluamos también las variables (usaurio) de gastos con respecto a edad, categoría de ciudad y tiempo de estancia en la ciudad, donde se observa que la edad que tiene una desviación mayor en el gasto en dinero es entre 51 y 55, así como la ciudad que tiene este mismo comportamiento es la C y las estancia de cero años y mayores a 4 años presentan compras inusuales. Este tipo de gráficas nos permiten observar en términos de dinero gastado, mientras que las gráficas evaluadas en el punto de categorización de datos presenta información sobre cantidades compradas.

```{r Plot_Exploracion_Datos3, echo=FALSE}
a4 <- friday %>% ggplot(aes(x=Age,y=purchase_replace,
                      fill=Age))+geom_boxplot()+
  theme(legend.position="none")

a5 <- friday %>% ggplot(aes(x=City_Category,y=purchase_replace,
                      fill=City_Category))+geom_boxplot()+
  theme(legend.position="none")

a6 <- friday %>% ggplot(aes(x=Stay_In_Current_City_Years,y=purchase_replace,
                            fill=Stay_In_Current_City_Years))+geom_boxplot()+
  theme(legend.position="none")

gridExtra::grid.arrange(a4,a5,a6)

```

Ahora vamos a analizar las variables relacionadas a producto como son sus categorias respecto al perfil del comprador.

Respecto al estado marital para la categoria 1:

1. Los productos tipo 4, 5, 12, 13 y 18, tienen pocas compras, siendo un mercado que tendría mayor crecimiento. 
2. El producto 9 tiene una mayor proporción de compra por parte de casados, al igual que el producto tipo 17.

Sobre categoria 2, tenemos una mayor uniformidad sobre las compras, sin embargo es posible tener un detalle específico sobre los productos mas atractivos.

Finalmente en la categoria 3, vemos una predilección por el producto tipo 9 y una diferencia importante en el producto 3 para solteros.

```{r Plot_Exploracion_Datos4, echo=FALSE}

p1 <- friday %>% ggplot(aes(x=as.factor(Product_Category_1),y=purchase_replace,
                            fill=as.factor(Marital_Status)))+geom_boxplot()
p2 <- friday %>% na.omit() %>% ggplot(aes(x=as.factor(Product_Category_2),y=purchase_replace,
                            fill=as.factor(Marital_Status)))+geom_boxplot()
p3 <-friday %>% na.omit() %>% ggplot(aes(x=as.factor(Product_Category_3),y=purchase_replace,
                           fill=as.factor(Marital_Status)), na.rm = TRUE)+geom_boxplot()

gridExtra::grid.arrange(p1,p2,p3)

```

De la misma manera evaluando la variable género respecto a las categorias de los productos, en la categoria 1 los tipo 9 tienen una media muy difente, las mujeres pagan mas que los hombres y los tipo 14 y 15 son preferidos por las mujeres; los tipos 17 y 18 son preferidos por los hombres. 
Para la categoria 2 tenemos preferencia femenina en los tipo 5, 6 y 10; diferencias marcadas en la cantidad gastada entre generos para los productos tipo 8 y 11.
Finalmente en la categoria 3, los productos tipo 3 proporcionan una mayor utilidad por parte de los hombres al igual que el tipo 8 y el 14; siendo el 9 el preferido por las mujeres.

```{r Plot_Exploracion_Datos5, echo=FALSE}
p4 <- friday %>% ggplot(aes(x=as.factor(Product_Category_1),y=purchase_replace,
                            fill=Gender))+geom_boxplot()
p5 <- friday %>% na.omit() %>% ggplot(aes(x=as.factor(Product_Category_2),y=purchase_replace,
                            fill=Gender))+geom_boxplot()
p6 <-friday %>% na.omit() %>% ggplot(aes(x=as.factor(Product_Category_3),y=purchase_replace,
                           fill=Gender), na.rm = TRUE)+geom_boxplot()

gridExtra::grid.arrange(p4,p5,p6)

```

A través del siguiente gráfico vemos los tipos de productos que generan un mayor gasto en orden:

```{r Plot_Exploracion_Datos6, echo=FALSE}
p7 <- friday %>% na.omit() %>% group_by(Product_Category_1) %>% count() %>% 
  ggplot(aes(x=reorder(Product_Category_1,n),y=n))+
  geom_col(aes(fill=as.factor(Product_Category_1)))+
  labs(x="",y="",title="Categoria 1")+theme(legend.position="none")

p8 <- friday %>% na.omit() %>% group_by(Product_Category_2) %>% count() %>% 
  ggplot(aes(x=reorder(Product_Category_2,n),y=n))+
  geom_col(aes(fill=as.factor(Product_Category_2)))+
  labs(x="",y="",title="Cateogoria 2")+theme(legend.position="none")

p9 <- friday %>% na.omit() %>% group_by(Product_Category_3) %>% count() %>% 
  ggplot(aes(x=reorder(Product_Category_3,n),y=n))+
  geom_col(aes(fill=as.factor(Product_Category_3)))+
  labs(x="",y="",title="Categoria 3")+theme(legend.position="none")

gridExtra::grid.arrange(p7,p8,p9)

```

Del siguiente gráfico podemos intuir que la densidad demográfica esta centrada en personas de las edades entre 26 -35 años, los cuales generan la mayor cantidad de dinero en compras; Se puede evidenciar un comportamiento poblacional similar en las diferentes ciudades, además de que la categoria 0, 8 y 18 son las más comunes, como dato curioso se puede determinar que la categoria 11 puede ser desempleado o estudiante, dada su predominancia en la edad de 0 - 17.

```{r Plot_Exploracion_Datos8, echo=FALSE}
par(old.par)
friday_user <- friday %>% group_by(User_ID) %>% 
  summarise(Purchase=sum(purchase_replace), 
            Cantidad=n(),
            Genero = unique(Gender),
            Marital = unique(Marital_Status),
            City_Category = unique(City_Category),
            Age = unique(Age),
            Stay_City = unique(Stay_In_Current_City_Years),
            occupation = as.factor(unique(Occupation))) %>% data.frame()

friday_user %>% ggplot()+
  geom_bar(stat = "identity", mapping = (aes(x=Age, y=Purchase, 
                                             color= occupation)))+
  facet_wrap(~City_Category, nrow = 2)

```

En este gráfico se combina la edad poblacional, el análisis por ciudad y el tiempo en la ciudad, en su relacion con el gasto, evidenciando que la gente con tiempos intermedios de duración en la ciudad son de 1 a 3 años, aunque se nota una clara participacion de las personas recien llegadas aun por encima de las que llevan varios años allí.

```{r Plot_Exploracion_Datos9, echo=FALSE}
par(old.par)
friday_user %>% ggplot()+ geom_bar(stat = "identity", mapping = (aes(x=Age, y=Purchase, color = Stay_City)))+ facet_wrap(~City_Category, nrow = 2)+ coord_polar()
```



```{r Particion_datos, include=FALSE}
set.seed(42) # semilla

train.size = dim(friday)[1] * 0.7 
train = sample(1:dim(friday)[1], train.size)
test = -train
datos.train = friday[train, ]
datos.test = friday[test, ]

```

## **Ejercicio de Clasificación**

A continuación realizaremos una clasificación por árboles aleatorios de la categorización de compras indicada anteriormente, con respecto a la cantidades adquiridas de acuerdo a su categoria:

```{r clasificacion, include=FALSE}

tree <- rpart(Purchase_cat ~ Product_Category_1 + Age + City_Category + 
                Stay_In_Current_City_Years + Gender,
              data = datos.train, method = "class", 
              control = rpart.control(minsplit = 20, cp = 0.01))

#tree$cptable
```

El árbol nos indica que el para las categorizaciones "Very_low", "Low", "Medium", y "Very_high", tenemos una probabilidad de ocurrencia del 4%, 57%, 8%, y 34% respectivamente de acuerdo a las cantidades de compras: 

```{r Plot_arbol1, echo=FALSE}
par(old.par)
prp(tree, type = 2, extra = 104, nn = TRUE, fallen.leaves = TRUE, roundint = F, faclen = 4,
    varlen = 8)
#tree_pruned <- prune(tree, tree$cptable[4, "CP"])
```

Realizamos el mismo ejercicio de clasificación con un agrupamiento por usuario y cantidades compradas:

```{r arbol2, include=FALSE}
###Arbol por Usarios y cantidades
friday_user <- friday %>% group_by(User_ID) %>% summarise(
  Purchase=sum(purchase_replace), Cantidad=n(), Genero = unique(Gender),
  Marital = unique(Marital_Status),City_Category = unique(City_Category),
  Age = unique(Age),Stay_City = unique(Stay_In_Current_City_Years),
  occupation = as.factor(unique(Occupation))) %>% data.frame()

friday_user$Purchase_replace <- replace_outliers(friday_user$Purchase, removeNA = F)

friday_user$purchase_cat <- cut(friday_user$Purchase_replace, breaks = 5, 
                                labels = c("Very_low", "Low", "Medium", "High", "Very_high"))

friday_user <- friday_user %>% mutate(Age_cat = ifelse(Age == "0-17", 1, Age))

set.seed(42)
train_u.id_G <- createDataPartition(friday_user$purchase_cat, p = 0.7, list = FALSE)
train_u <- friday_user[train_u.id_G, ]
test_u <- friday_user[-train_u.id_G, ]


tree_cantidad <- rpart(purchase_cat ~ Cantidad, data = friday_user[train_u.id_G,],
              method = "class", control = rpart.control(minsplit = 20, cp = 0.01))

#tree_cantidad$cptable
#tree_cantidad_pruned <- prune(tree_cantidad, tree_cantidad$cptable[4, "CP"])

```

Para esta clasificación tenemos aparecen todas las categorizaciones "Very_low", "Low", "Medium", "High" y "Very_high", con una ocurrencia del 53%, 24%, 9%, 5% y 8% respectivamente, a diferencia del ejericicio anterior la categoria "High" presenta valores para cantidades mayores a 179.

```{r Plot_arbol2, echo=FALSE}
par(old.par)
prp(tree_cantidad, type = 2, extra = 104, nn = TRUE, fallen.leaves = TRUE, 
    roundint = F, faclen = 4,varlen = 8)
```

## **Ejercicio de Predicción**

Inicialmente realizamos una predicción a través de los árboles de clasificación del punto anterior, utilizando un 70% de los datos como entrenamiento y el restante como prueba.

Desafortunadamente, nuestra predicción no es muy acertada, a través de la tabla de confusión vemos que las categorías "Very_low", "Low" y "High" se tiene las mejores predicciones, pero siendo muy pobres para las demás categorias.
```{r prediccion1, echo=FALSE}
# Arbol

pred.tree <- predict(tree, datos.test, type = "class")
table(datos.test$Purchase_cat, pred.tree, dnn = c("Actual", "Predicho"))
#Prediccion por Usarios y cantidades
```

Para el segundo caso con agrupamiento de usaurio, tenemos una mejor predicción sobre todas las categorias:

```{r prediccion2, echo=FALSE}
pred.cantidad <- predict(tree_cantidad, friday_user[-train_u.id_G, ], type = "class")
table(friday_user[-train_u.id_G, ]$purchase_cat, pred.cantidad, dnn = c("Actual", "Predicho"))

```


Ahora vamos a utilizar el método de Radom Forest para la clasificación de las compras en los intervalos de gastos especificados, con el fin de categorizar cuánto dinero gastará un cliente en una sola compra.

Tenemos los siguientes resultados:

```{r random_forest1, include=FALSE}

friday_rf <- friday %>% select(Gender:Product_Category_3, Purchase_cat, purchase_replace)
friday_rf <- mutate(friday_rf, Product2 = as.integer(!is.na(Product_Category_2)),
               Product3 = as.integer(!is.na(Product_Category_3)))
friday_rf <- friday_rf[, -c(8,9)]

set.seed(42)

muestra <- sample(dim(friday_rf)[1], size = dim(friday_rf)[1]*0.1)
length(muestra)
train <- friday_rf[muestra,]
test <- friday_rf[-muestra,]

k <- 9
rf.OOB <- c()
for(j in 1:k){
   rf = randomForest(Purchase_cat ~. -purchase_replace,
                     data=train, ntree=100, mtry = j)
   rf.OOB[j] <- mean(rf$err.rate[,"OOB"])
}

mintry <- which.min(rf.OOB)
set.seed(42)
rf = randomForest(Purchase_cat~.,data=train, ntree=100, mtry = mintry)
OOB <-mean(rf$err.rate[,"OOB"])
rf.pred = predict(rf,test)
rf.cc = mean(rf.pred==test$Purchase_cat)
```

Mediante el análisis de OOB (error de "Out Of bag") de cada arbol aleatorio, determinamos el número óptimo de variables aleatorias a escoger, usadas en cada paso de decision que disminuya el error de clasificación, en este caso es `r mintry`. Al generar un Random Forest con las especificaciones óptimas, después de optimizar también el numero de árboles necesarios para el bosque conseguimos un porcentaje de datos correctamente clasificados de: `r rf.cc`.

La evolución del error de clasificación la podemos observar en el siguiente grafico:

```{r plot_rf1, echo=FALSE}
plot(rf, main = "Error OOB por categoria")
A <- as.matrix(table(rf.pred, test$Purchase_cat))
A
```


```{r random_forest2, include=FALSE}

###

rf.OOB <- c()
for(j in 1:k){
  rf = randomForest(Product_Category_1 ~. -Purchase_cat,
                    data=train, ntree=500, mtry = j)
  rf.OOB[j] <- mean(rf$err.rate[,"OOB"])
}

mintry1 <- which.min(rf.OOB)
set.seed(42)
rf = randomForest(Product_Category_1~.-Purchase_cat,data=train, ntree=500, mtry = mintry)
OOB <-mean(rf$err.rate[,"OOB"])

rf.pred = predict(rf,test)
rf.cc1 = mean(rf.pred==test$Product_Category_1)

```

En vista de la efectividad de la clasificación, decidimos determinar si se puede predecir ó eventualmente categorizar nuevos productos para la (categoria1), apartir de un método de bosques aleatorios, consiguiedo los siguientes resultados: porcentaje de datos correctamente clasificados de: `r rf.cc1` variables aleatoreas que disminiyan el error de clasificacion: `r mintry1`.

La evolución del error de clasificación la podemos observar en el siguiente grafico:

```{r plot_rf2, echo=FALSE}
plot(rf, main = "Error OOB por categoria")
A <- as.matrix(table(rf.pred, test$Product_Category_1))
```

